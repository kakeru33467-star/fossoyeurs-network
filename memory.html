<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Vérification Cognitive</title>
<link rel="stylesheet" href="style.css">

<style>

.memory-container{
    padding:40px;
    text-align:center;
}

/* -------- PHASE 1 -------- */

.memory-grid{
    display:grid;
    grid-template-columns:repeat(5,120px);
    gap:15px;
    justify-content:center;
    margin-top:40px;
}

.memory-card{
    width:120px;
    height:160px;
    perspective:1000px;
    cursor:pointer;
}

.memory-inner{
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition:transform 0.5s;
}

.memory-card.flipped .memory-inner{
    transform:rotateY(180deg);
}

.face,.back{
    position:absolute;
    width:100%;
    height:100%;
    backface-visibility:hidden;
}

.face img,.back img{
    width:100%;
    height:100%;
    object-fit:cover;
}

.back{
    transform:rotateY(180deg);
}

/* -------- PHASE 2 -------- */

.assignment-zone{
    display:flex;
    justify-content:center;
    gap:25px;
    margin-top:40px;
}

.drop-slot{
    width:140px;
    height:180px;
    border:1px dashed #555;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    font-size:11px;
    color:#777;
}

.cards-zone{
    position:relative;
    width:720px;
    height:200px;
    margin:60px auto;
}

.shuffle-card{
    width:140px;
    height:180px;
    position:absolute;
    transition:left 0.6s ease;
    cursor:grab;
    perspective:1000px;
}

.shuffle-inner{
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition:transform 0.6s;
}

.shuffle-inner .face,
.shuffle-inner .back{
    position:absolute;
    width:100%;
    height:100%;
    backface-visibility:hidden;
}

.shuffle-inner .back{
    transform:rotateY(180deg);
}

.shuffle-inner img{
    width:100%;
    height:100%;
    object-fit:cover;
}

</style>
</head>
<body>

<div class="memory-container">
<h1>VÉRIFICATION COGNITIVE</h1>
<p class="subtitle">Étape 1 — Association</p>
<div class="memory-grid" id="memoryGrid"></div>
</div>

<script>

/* ---------------- PHASE 1 ---------------- */

const characters=[
"soma_toma.jpg",
"Reikuro.jpg",
"Sahir.jpg",
"Tatsumaki.jpg",
"Shu.jpg"
];

let cards=[...characters,...characters];
cards.sort(()=>Math.random()-0.5);

const grid=document.getElementById("memoryGrid");

let flipped=[];
let matched=0;

cards.forEach(img=>{

    const card=document.createElement("div");
    card.classList.add("memory-card");

    card.innerHTML=`
        <div class="memory-inner">
            <div class="face">
                <img src="images/card_back.jpg">
            </div>
            <div class="back">
                <img src="images/${img}">
            </div>
        </div>
    `;

    card.addEventListener("click",()=>{

        if(card.classList.contains("flipped")||flipped.length===2) return;

        card.classList.add("flipped");
        flipped.push({card,img});

        if(flipped.length===2){
            if(flipped[0].img===flipped[1].img){
                matched++;
                flipped=[];
                if(matched===characters.length){
                    setTimeout(startPhase2,1200);
                }
            }else{
                setTimeout(()=>{
                    flipped.forEach(c=>c.card.classList.remove("flipped"));
                    flipped=[];
                },800);
            }
        }
    });

    grid.appendChild(card);
});

/* ---------------- PHASE 2 ---------------- */

function startPhase2(){

    document.querySelector("h1").innerText="RECONSTITUTION IDENTITAIRE";
    document.querySelector(".subtitle").innerText="Suivez les cartes attentivement";

    grid.remove();

    const container=document.querySelector(".memory-container");

    const assignmentZone=document.createElement("div");
    assignmentZone.classList.add("assignment-zone");

    const targets=[
        {name:"Soma & Thomas",img:"soma_toma.jpg"},
        {name:"Sahir",img:"Sahir.jpg"},
        {name:"Reikuro",img:"Reikuro.jpg"},
        {name:"Tatsumaki",img:"Tatsumaki.jpg"}
    ];

    targets.forEach(t=>{
        const slot=document.createElement("div");
        slot.classList.add("drop-slot");
        slot.dataset.correct=t.img;
        slot.innerHTML=`<strong>${t.name}</strong>`;
        slot.addEventListener("dragover",e=>e.preventDefault());
        slot.addEventListener("drop",e=>{
            e.preventDefault();

            const cardId=e.dataTransfer.getData("text");
            const dragged=document.querySelector(`[data-id='${cardId}']`);

            if(!dragged||slot.querySelector(".shuffle-card")) return;

            slot.appendChild(dragged);
            dragged.style.position="static";
            dragged.draggable=false;

            checkCompletion();
        });

        assignmentZone.appendChild(slot);
    });

    container.appendChild(assignmentZone);

    const cardsZone=document.createElement("div");
    cardsZone.classList.add("cards-zone");
    container.appendChild(cardsZone);

    let shuffled=[...targets];
    shuffled.sort(()=>Math.random()-0.5);

    const positions=[0,180,360,540];
    const cardsList=[];

    shuffled.forEach((t,i)=>{
        const card=document.createElement("div");
        card.classList.add("shuffle-card");
        card.dataset.img=t.img;
        card.dataset.id="card_"+i;
        card.style.left=positions[i]+"px";

        card.innerHTML=`
            <div class="shuffle-inner">
                <div class="face">
                    <img src="images/${t.img}">
                </div>
                <div class="back">
                    <img src="images/card_back.jpg">
                </div>
            </div>
        `;

        cardsZone.appendChild(card);
        cardsList.push(card);
    });

    // visible 2s
    setTimeout(()=>{
        cardsList.forEach(c=>{
            c.querySelector(".shuffle-inner").style.transform="rotateY(180deg)";
        });

        // mélange
        setTimeout(()=>{
            let swaps=8;
            let count=0;

            const interval=setInterval(()=>{

                const a=Math.floor(Math.random()*4);
                let b=Math.floor(Math.random()*4);
                if(a===b) b=(b+1)%4;

                const posA=cardsList[a].style.left;
                const posB=cardsList[b].style.left;

                cardsList[a].style.left=posB;
                cardsList[b].style.left=posA;

                const temp=cardsList[a];
                cardsList[a]=cardsList[b];
                cardsList[b]=temp;

                count++;

                if(count>=swaps){
                    clearInterval(interval);

                    cardsList.forEach(c=>{
                        c.draggable=true;
                        c.addEventListener("dragstart",e=>{
                            e.dataTransfer.setData("text",c.dataset.id);
                        });
                    });
                }

            },900);

        },800);

    },2000);
}

function checkCompletion(){

    const slots=document.querySelectorAll(".drop-slot");

    let allFilled=true;
    slots.forEach(slot=>{
        if(!slot.querySelector(".shuffle-card")){
            allFilled=false;
        }
    });

    if(!allFilled) return;

    let correct=true;
    slots.forEach(slot=>{
        const card=slot.querySelector(".shuffle-card");
        if(card.dataset.img!==slot.dataset.correct){
            correct=false;
        }
    });

    if(correct){
        setTimeout(()=>{
            window.location.href="enfants.html";
        },1000);
    }else{

        // Animation rouge
        slots.forEach(s=>s.style.border="1px solid #8b0000");

        setTimeout(()=>{
            resetPhase2();
        },1200);
    }
}

function resetPhase2(){

    const container=document.querySelector(".memory-container");

    // Supprimer ancienne phase 2
    const oldAssignment=document.querySelector(".assignment-zone");
    const oldCards=document.querySelector(".cards-zone");

    if(oldAssignment) oldAssignment.remove();
    if(oldCards) oldCards.remove();

    // Relancer proprement la phase 2
    startPhase2();
}    
    
</script>

</body>
</html>
